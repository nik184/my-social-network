<!DOCTYPE html>
<html>
<head>
    <title>My Social Network - Friends</title>
    <link rel="stylesheet" href="css/shared.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-brand">üåê My Social Network</div>
            <div class="nav-links">
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="index.html" class="nav-link">Network</a>
                <a href="friends.html" class="nav-link active">Friends</a>
            </div>
        </nav>

        <!-- Friends Header -->
        <div class="header">
            <h1>üë• My Friends</h1>
            <p>Manage your friends and view their profiles</p>
        </div>

        <!-- Friends Section -->
        <div class="section">
            <h3>Friends List</h3>
            <div id="friendsStatus" class="status" style="display: none;"></div>
            <div id="friendsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <div>Loading friends...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Friend Profile Modal -->
    <div id="friendProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div id="friendProfileModalTitle" class="modal-title">Friend Profile</div>
                <span class="close" onclick="closeFriendProfileModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="friendProfileContent">
                    <div class="profile-header">
                        <div id="friendAvatar" class="profile-avatar">
                            üë§
                        </div>
                        <h1 id="friendName" class="profile-name">Loading...</h1>
                        <p id="friendId" class="profile-id">Peer ID: ...</p>
                    </div>
                    
                    <div class="section">
                        <h3>üìù Notes</h3>
                        <div id="friendNotesStatus" class="status" style="display: none;"></div>
                        <div id="friendNotesContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <div>Loading notes...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Detail Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div id="noteModalTitle" class="modal-title">Note</div>
                <span class="close" onclick="closeNoteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="noteModalMeta" class="note-full-meta"></div>
                <div id="noteModalContent" class="note-content"></div>
            </div>
        </div>
    </div>

    <script src="js/shared.js"></script>
    <script>
        let currentFriend = null;
        let friendNotes = [];

        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadFriends();
        });

        // Load friends from the server
        async function loadFriends() {
            try {
                sharedApp.showStatus('friendsStatus', 'Loading friends...', false);
                
                const data = await sharedApp.fetchAPI('/api/friends');
                
                displayFriends(data.friends || []);
                sharedApp.hideStatus('friendsStatus');
            } catch (error) {
                console.error('Error loading friends:', error);
                sharedApp.showStatus('friendsStatus', 'Error loading friends: ' + error.message, true);
                displayEmptyState('Failed to load friends');
            }
        }

        // Display friends in the list
        function displayFriends(friends) {
            const friendsContent = document.getElementById('friendsContent');
            
            if (friends.length === 0) {
                displayEmptyState('No friends found');
                return;
            }

            let friendsHtml = '<div style="display: grid; gap: 15px;">';

            friends.forEach(async (friend, index) => {
                const addedDate = new Date(friend.added_at).toLocaleDateString();
                const lastSeenText = friend.last_seen 
                    ? new Date(friend.last_seen).toLocaleString()
                    : 'Never';
                const onlineStatus = friend.is_online ? 'Online' : 'Offline';
                const statusColor = friend.is_online ? '#155724' : '#721c24';

                // Load friend's avatar
                const avatarInfo = await sharedApp.getPeerAvatar(friend.peer_id);
                const avatarHtml = sharedApp.createPeerAvatarElement(friend.peer_id, avatarInfo, '50px');

                const friendCard = `
                    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: #f8f9fa; cursor: pointer;" onclick="openFriendProfile('${friend.peer_id}', '${sharedApp.escapeHtml(friend.peer_name)}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;">
                                ${avatarHtml}
                                <div style="margin-left: 15px;">
                                    <strong style="font-size: 18px;">${sharedApp.escapeHtml(friend.peer_name)}</strong>
                                    <br>
                                    <small style="color: #666;">
                                        Added: ${addedDate} ‚Ä¢ Last seen: ${lastSeenText}
                                        <br>
                                        Status: <span style="color: ${statusColor}; font-weight: bold;">${onlineStatus}</span>
                                    </small>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="button" onclick="event.stopPropagation(); openFriendProfile('${friend.peer_id}', '${sharedApp.escapeHtml(friend.peer_name)}')">View Profile</button>
                                <button class="button" onclick="event.stopPropagation(); removeFriend('${friend.peer_id}', '${sharedApp.escapeHtml(friend.peer_name)}')" style="background-color: #dc3545;">Remove</button>
                            </div>
                        </div>
                    </div>
                `;

                // Add the card to the container
                if (index === 0) {
                    friendsHtml = friendCard;
                    friendsContent.innerHTML = friendsHtml;
                } else {
                    friendsContent.innerHTML += friendCard;
                }
            });
        }

        // Display empty state
        function displayEmptyState(message) {
            const friendsContent = document.getElementById('friendsContent');
            friendsContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <div>${message}</div>
                    <div class="create-note-hint">
                        üí° Add friends from the Network page's Connection History
                    </div>
                </div>
            `;
        }

        // Remove a friend
        async function removeFriend(peerID, friendName) {
            if (!confirm(`Are you sure you want to remove ${friendName} from your friends?`)) {
                return;
            }

            try {
                sharedApp.showStatus('friendsStatus', `Removing ${friendName}...`, false);
                
                const response = await fetch(`/api/friends/${encodeURIComponent(peerID)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to remove friend');
                }
                
                sharedApp.showStatus('friendsStatus', `‚úÖ ${friendName} removed from friends`, false);
                
                // Reload friends list
                setTimeout(() => {
                    loadFriends();
                }, 1000);
                
            } catch (error) {
                console.error('Error removing friend:', error);
                sharedApp.showStatus('friendsStatus', `‚ùå Failed to remove ${friendName}: ${error.message}`, true);
            }
        }

        // Open friend profile modal
        async function openFriendProfile(peerID, friendName) {
            currentFriend = { peer_id: peerID, peer_name: friendName };
            
            document.getElementById('friendProfileModalTitle').textContent = `${friendName}'s Profile`;
            document.getElementById('friendName').textContent = friendName;
            document.getElementById('friendId').textContent = `Peer ID: ${peerID}`;

            // Load friend's avatar
            const avatarInfo = await sharedApp.getPeerAvatar(peerID);
            const friendAvatar = document.getElementById('friendAvatar');
            if (avatarInfo && avatarInfo.hasAvatar) {
                friendAvatar.innerHTML = `<img src="${avatarInfo.url}" alt="Avatar" />`;
            } else {
                friendAvatar.innerHTML = 'üë§';
            }

            // Load friend's notes (this will be implemented with P2P protocol)
            await loadFriendNotes(peerID);

            document.getElementById('friendProfileModal').style.display = 'block';
        }

        // Load friend's notes via P2P
        async function loadFriendNotes(peerID) {
            try {
                sharedApp.showStatus('friendNotesStatus', 'Loading notes via P2P...', false);
                
                const data = await sharedApp.fetchAPI(`/api/peer-notes/${peerID}`);
                
                displayFriendNotes(data.notes || []);
                sharedApp.hideStatus('friendNotesStatus');
            } catch (error) {
                console.error('Error loading friend notes:', error);
                sharedApp.showStatus('friendNotesStatus', 'Error loading notes: ' + error.message, true);
                displayFriendNotesEmptyState('Failed to load notes from friend');
            }
        }

        // Display friend's notes
        function displayFriendNotes(notes) {
            const friendNotesContent = document.getElementById('friendNotesContent');
            
            if (notes.length === 0) {
                displayFriendNotesEmptyState('No notes found');
                return;
            }

            const notesGrid = document.createElement('div');
            notesGrid.className = 'notes-grid';

            notes.forEach(note => {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';

                const modifiedDate = new Date(note.modified_at).toLocaleDateString();
                const sizeKB = Math.round(note.size / 1024 * 100) / 100;

                noteCard.innerHTML = `
                    <div class="note-title">${sharedApp.escapeHtml(note.title)}</div>
                    <div class="note-meta">
                        <span>üìÖ ${modifiedDate}</span>
                        <span>üìÑ ${sizeKB} KB</span>
                    </div>
                    <div class="note-preview">${sharedApp.escapeHtml(note.preview)}</div>
                    <div class="note-actions">
                        <button class="read-more-btn" onclick="openFriendNote('${currentFriend.peer_id}', '${sharedApp.escapeHtml(note.filename)}')">
                            Read more
                        </button>
                    </div>
                `;

                notesGrid.appendChild(noteCard);
            });

            friendNotesContent.innerHTML = '';
            friendNotesContent.appendChild(notesGrid);
        }

        // Display empty state for friend notes
        function displayFriendNotesEmptyState(message) {
            const friendNotesContent = document.getElementById('friendNotesContent');
            friendNotesContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <div>${message}</div>
                    <div class="create-note-hint">
                        üì° Notes are requested directly from your friend via P2P connection
                    </div>
                </div>
            `;
        }

        // Close friend profile modal
        function closeFriendProfileModal() {
            document.getElementById('friendProfileModal').style.display = 'none';
            currentFriend = null;
        }

        // Note modal functions
        function closeNoteModal() {
            sharedApp.closeNoteModal();
        }

        // Open a specific friend note
        async function openFriendNote(peerID, filename) {
            try {
                const note = await sharedApp.fetchAPI(`/api/peer-notes/${peerID}/${encodeURIComponent(filename)}`);
                
                document.getElementById('noteModalTitle').textContent = note.title;
                document.getElementById('noteModalMeta').innerHTML = `
                    <strong>From:</strong> ${sharedApp.escapeHtml(currentFriend.peer_name)}<br>
                    <strong>Filename:</strong> ${sharedApp.escapeHtml(note.filename)}<br>
                    <strong>Modified:</strong> ${new Date(note.modified_at).toLocaleString()}<br>
                    <strong>Size:</strong> ${Math.round(note.size / 1024 * 100) / 100} KB
                `;
                document.getElementById('noteModalContent').textContent = note.content;
                
                document.getElementById('noteModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading friend note:', error);
                alert('Error loading note: ' + error.message);
            }
        }

        // Open a specific note (fallback function)
        async function openNote(filename) {
            if (currentFriend) {
                await openFriendNote(currentFriend.peer_id, filename);
            } else {
                alert('No friend selected');
            }
        }
    </script>
</body>
</html>